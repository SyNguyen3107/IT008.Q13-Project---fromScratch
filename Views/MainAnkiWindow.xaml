<Window x:Class="IT008.Q13_Project___fromScratch.MainAnkiWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:IT008.Q13_Project___fromScratch"
        mc:Ignorable="d"
        Title="Anki" Height="800" Width="1200"
        ResizeMode="NoResize"
        WindowStartupLocation="CenterScreen"
        Background="#2c2c2c"
        Loaded="MainAnkiWindowLoaded"
        Icon="/Resources/Anki-icon.ico">

    <Window.Resources>
        <!-- (Giữ nguyên Resources cũ) -->
        <Style x:Key="NavButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
        <!-- Style cho Tiêu đề cột (Header) -->
        <Style x:Key="DarkGridViewColumnHeader" TargetType="GridViewColumnHeader">
            <Setter Property="Background" Value="#444"/>
            <!-- Nền tối -->
            <Setter Property="Foreground" Value="White"/>
            <!-- Chữ trắng -->
            <Setter Property="BorderBrush" Value="#555"/>
            <!-- Viền xám -->
            <Setter Property="BorderThickness" Value="0,0,1,1"/>
            <Setter Property="Padding" Value="5"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <!-- Xử lý khi di chuột (Hover) -->
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#555"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <!-- Style tối giản cho ScrollBar -->
        <Style x:Key="DarkScrollBarStyle" TargetType="{x:Type ScrollBar}">
            <Setter Property="Stylus.IsPressAndHoldEnabled" Value="false"/>
            <Setter Property="Stylus.IsFlicksEnabled" Value="false"/>
            <Setter Property="Background" Value="#2c2c2c"/>
            <!-- Nền của thanh trượt -->
            <Setter Property="Foreground" Value="#555"/>
            <!-- Màu của cục trượt (Thumb) -->
            <Setter Property="Width" Value="10"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ScrollBar}">
                        <Grid x:Name="Bg" SnapsToDevicePixels="true">
                            <Track x:Name="PART_Track" IsDirectionReversed="true">
                                <Track.Thumb>
                                    <Thumb Style="{DynamicResource ScrollThumbStyle}"/>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Style cho cục trượt (Thumb) -->
        <Style x:Key="ScrollThumbStyle" TargetType="{x:Type Thumb}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Thumb}">
                        <Border Background="#666" CornerRadius="4"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <!-- GÁN SỰ KIỆN CHO GRID CHÍNH ĐỂ PHẠM VI RỘNG NHẤT -->
    <Grid MouseDown="ClearSelection_MouseDown" Background="Transparent">
        <!-- Background="Transparent" là cần thiết để Grid nhận được sự kiện click chuột -->

        <!-- Chia layout 4 hàng -->
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Menu trên cùng (Giữ nguyên) -->
        <Menu Grid.Row="0" Background="#2c2c2c" Foreground="White" FontSize="14" BorderThickness="0">
            <!-- ... (Nội dung Menu cũ) ... -->
            <MenuItem Header="_File">
                <MenuItem Header="_Import" Cursor="Hand" InputGestureText="Ctrl+Shift+I" Foreground="Black" Command="{Binding ImportFileCommand}" />
                <MenuItem Header="_Export" Cursor="Hand" InputGestureText="Ctrl+E" Foreground="Black"/>
                <Separator/>
                <MenuItem Header="E_xit" Cursor="Hand" InputGestureText="Ctrl+Q" Foreground="Black"/>
            </MenuItem>
            <MenuItem Header="_Edit" Foreground="White">
                <MenuItem Header="Undo" Cursor="Hand" InputGestureText="Ctrl+Z" Foreground="Gray"/>
            </MenuItem>
            <MenuItem Header="_Tools" Foreground="White">
                <MenuItem Header="_Preferences" Cursor="Hand" InputGestureText="Ctrl+P" Foreground="Black"/>
            </MenuItem>
            <MenuItem Header="_Help" Foreground="White">
                <MenuItem Header="About Anki" Cursor="Hand" Foreground="Black"/>
            </MenuItem>
        </Menu>

        <!-- Thanh Deck/Add/Browse/Stats/Sync (Giữ nguyên) -->
        <Border Grid.Row="1" Background="#434343" CornerRadius="15" HorizontalAlignment="Left" VerticalAlignment="Top" BorderBrush="#444" BorderThickness="1" Padding="5,0" Margin="443,0,0,0" Height="34">
            <!-- ... (Nội dung thanh nút cũ) ... -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                <Button Content="Decks" Style="{StaticResource NavButtonStyle}" Margin="10,0"/>
                <Button Content="Add" Style="{StaticResource NavButtonStyle}" Margin="10,0" Command="{Binding AddCardCommand}" />
                <Button Content="Browse" Style="{StaticResource NavButtonStyle}" Margin="10,0"/>
                <Button Content="Stats" Style="{StaticResource NavButtonStyle}" Margin="10,0"/>
                <Button Content="Sync" Style="{StaticResource NavButtonStyle}" Margin="10,0" />
            </StackPanel>
        </Border>

        <!-- Bảng hiển thị Deck -->
        <!-- BỎ MouseDown Ở ĐÂY VÌ ĐÃ GÁN CHO GRID -->
        <Border Grid.Row="2" Height="Auto" Width="800" Background="#363636" CornerRadius="15" Margin="30">

            <ListView x:Name="DeckListView" 
                      ItemsSource="{Binding Decks}" 
                      SelectionChanged="ListView_SelectionChanged" 
                      Background="Transparent" 
                      BorderThickness="0" 
                      Margin="0, 0, 0, 0" 
                      Grid.RowSpan="2">
                <ListView.Resources>
                    <!-- Tự động áp dụng cho mọi ScrollBar trong ListView này -->
                    <Style TargetType="ScrollBar" BasedOn="{StaticResource DarkScrollBarStyle}"/>
                </ListView.Resources>
                <!-- ... (Phần ItemContainerStyle và View giữ nguyên như cũ) ... -->
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListViewItem">
                                    <Border x:Name="Bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" Padding="{TemplateBinding Padding}" SnapsToDevicePixels="true" CornerRadius="5" Margin="2">
                                        <GridViewRowPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="Bd" Property="Background" Value="#4a4a4a"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="Bd" Property="Background" Value="#0078D7"/>
                                            <Setter Property="Foreground" Value="White"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListView.ItemContainerStyle>

                <ListView.View>
                    <GridView ColumnHeaderContainerStyle="{StaticResource DarkGridViewColumnHeader}">
                        <GridViewColumn Header="Deck" Width="580">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center" Padding="5" Foreground="White"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <GridViewColumn Header="New" Width="50">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding NewCount}" TextAlignment="Right" Foreground="RoyalBlue" FontWeight="Bold" VerticalAlignment="Center" Padding="5"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <GridViewColumn Header="Learn" Width="50">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding LearnCount}" TextAlignment="Right" Foreground="Red" VerticalAlignment="Center" Padding="5"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <GridViewColumn Header="Due" Width="50">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DueCount}" TextAlignment="Right" Foreground="ForestGreen" FontWeight="Bold" VerticalAlignment="Center" Padding="5"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <GridViewColumn Width="50">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="⚙"
                                            FontSize="16"
                                            Foreground="Gray"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Cursor="Hand"
                                            Click="GearButton_Click"
                                            Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}">

                                        <Button.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="Rename" 
                                                          Command="{Binding PlacementTarget.Tag.RenameDeckCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <MenuItem Header="Options" 
                                                          Command="{Binding PlacementTarget.Tag.DeckOptionsCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <MenuItem Header="Export" 
                                                          Command="{Binding PlacementTarget.Tag.ExportDeckCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                                <Separator/>
                                                <MenuItem Header="Delete" 
                                                          Command="{Binding PlacementTarget.Tag.DeleteDeckCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                          Foreground="Red"/>
                                            </ContextMenu>
                                        </Button.ContextMenu>

                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Visibility" Value="Hidden"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=ListViewItem}, Path=IsMouseOver}" Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Setter Property="Foreground" Value="White"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>
                    </GridView>
                </ListView.View>
            </ListView>
        </Border>

        <!-- Thanh nút dưới (Giữ nguyên) -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,20">
            <!-- ... (Nội dung thanh nút cũ) ... -->
            <Border Background="#434343" CornerRadius="15" Padding="5,2" Margin="8,0">
                <Button Content="Get Shared" Command="{Binding GetSharedCommand}" Style="{StaticResource NavButtonStyle}"/>
            </Border>
            <Border Background="#434343" CornerRadius="15" Padding="5,2" Margin="8,0">
                <Button Content="Create Deck" Command="{Binding CreateDeckCommand}" Style="{StaticResource NavButtonStyle}" />
            </Border>
            <Border Background="#434343" CornerRadius="15" Padding="5,2" Margin="8,0">
                <Button Content="Import File" Command="{Binding ImportFileCommand}" Style="{StaticResource NavButtonStyle}"/>
            </Border>
        </StackPanel>

    </Grid>
</Window>